<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Arbitrary HTML</title>
    
    <link rel="icon"
      href="https://cdn.glitch.com/3b5435b3-c38c-479b-a5a7-d254c2e23cc0%2Fchaos.png?v=1600527757494">
    
    <style>
* {
  box-sizing: border-box;
}

.big {
  width: 100%;
  height: 500px;
}
    </style>
    
    <script>
// redirect to secure connection
location.protocol === 'http:' && (location.protocol = 'https:');
      
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
      
function textChange(newText=null) {
  const textarea = document.querySelector('textarea');
  const targetVal = newText || textarea.value;
  const a = document.querySelector('a#gen');
  const iframe = document.querySelector('iframe');
  a.href = location.origin +'/#'+ encodeURI(targetVal);
  if (newText)  // If changed by iframe
    textarea.value = targetVal;
  else {
    iframe.srcdoc = '<html contenteditable="true" oninput="window.parent.textChange(this.innerHTML)">'+ targetVal + '</html>';
    iframe.contentWindow.isEditor = true;
  }
  //location.hash = 'edit=' + encodeURI(targetVal);
  history.replaceState(null, null, '#edit=' + encodeURI(targetVal));
}

// Adapted from https://stackoverflow.com/questions/11076975/how-to-insert-text-into-the-textarea-at-the-current-cursor-position
function insertAtCursor(myField, myValue) {
    //IE support
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
    }
    //MOZILLA and others
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos)
            + myValue
            + myField.value.substring(endPos, myField.value.length);
    } else {
        myField.value += myValue;
    }
}

function handlePaste(event) {
  let paste = (event.clipboardData || window.clipboardData).getData('text');
  // Remove site URL prefix
  const regex = new RegExp('^' + location.origin + '/?#?(edit=)?');
  paste = decodeURI(paste).replace(regex, '');

  insertAtCursor(event.target, paste);
  textChange();

  event.preventDefault();
}

function copyTo(target) {
  navigator.clipboard.writeText(document.querySelector('a#gen').href);
  target.innerText = 'Copied!';
  setTimeout(() => target.innerText = "Copy to Clipboard", 2000);
}

window.onload = () => {
  const textarea = document.querySelector('textarea');
  const cmd = location.hash.split('=')[0];
  if (cmd === '#edit') {
    textarea.value = decodeURI(location.hash.substring(6));
    document.title = "Edit | " + document.title;
    textChange();
  } else {
    document.write(document.head.outerHTML + decodeURI(location.hash.substring(1)));
  }
  document.body.style.display = 'unset';
}
    </script>
  </head>
  <body style="overflow-wrap: anywhere; display: none;">
    Insert the URI encoded HTML after "https://arbitrary-html.glitch.me/#"<br />
    Anything after "#edit=" will be displayed in this editor<br />
    <a href="/presets.html#edit=" target="_blank" title="Opens in new tab">Start from a template?</a><br />
    TIP: pasting encoded URIs will be automaticly decoded!
    <p>
      <a href="#" target="_blank" title="Opens in new tab" id="gen">Generated Link</a> <button onclick="copyTo(this)">Copy to Clipboard</button><br />
      <textarea placeholder="HTML code" class="big" oninput="textChange()" onpaste="handlePaste(event)"></textarea>
    </p>
    Preview: (editable!)<br />
    TIP: use ctr/command+ B/I/U to apply bold, italics, and underline respectively
    <p><iframe src="about:blank" class="big"></iframe></p>
  </body>
</html>
