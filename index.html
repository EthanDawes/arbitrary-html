<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Arbitrary HTML</title>
    
    <style>
* {
  box-sizing: border-box;
}

.big {
  width: 100%;
  height: 500px;
}
    </style>
    
    <script>
// redirect to secure connection
location.protocol === 'http:' && (location.protocol = 'https:');
      
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
      
function textChange() {
  const target = document.querySelector('textarea');
  const a = document.querySelector('a');
  const iframe = document.querySelector('iframe');
  a.href = location.origin +'/#'+ encodeURI(target.value);
  iframe.srcdoc = target.value;
  location.hash = 'edit=' + encodeURI(target.value);
  //history.replaceState(null, null, '?' + encodeURI(target.value));
}

// Adapted from https://stackoverflow.com/questions/11076975/how-to-insert-text-into-the-textarea-at-the-current-cursor-position
function insertAtCursor(myField, myValue) {
    //IE support
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
    }
    //MOZILLA and others
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos)
            + myValue
            + myField.value.substring(endPos, myField.value.length);
    } else {
        myField.value += myValue;
    }
}

function handlePaste(event) {
    let paste = (event.clipboardData || window.clipboardData).getData('text');
    paste = decodeURI(paste);
  
    insertAtCursor(event.target, paste);
    textChange();

    event.preventDefault();
}

function copyTo(target) {
  navigator.clipboard.writeText(document.querySelector('a').href);
  target.innerText = 'Copied!';
  setTimeout(() => target.innerText = "Copy to Clipboard", 2000);
}

window.onload = () => {
  const textarea = document.querySelector('textarea');
  const cmd = location.hash.split('=')[0];
  if (cmd === '#edit') {
    textarea.value = decodeURI(location.hash.substring(6));
    textChange();
  } else {
    document.body.innerHTML = decodeURI(location.hash.substring(1));
  }
  document.body.style.display = 'unset';
}
    </script>
  </head>
  <body style="overflow-wrap: anywhere; display: none;">
    Insert the URI encoded HTML after "https://arbitrary-html.glitch.me/#"<br />
    Anything after "#edit=" will be displayed in this editor<br />
    TIP: pasting encoded URIs will be automaticly decoded!
    <p>
      <a href="#" target="_blank" title="Opens in new tab">Generated Link</a> <button onclick="copyTo(this)">Copy to Clipboard</button><br />
      <textarea placeholder="HTML code" class="big" oninput="textChange()" onpaste="handlePaste(event)"></textarea>
    </p>
    Preview:
    <p><iframe src="about:blank" class="big"></iframe></p>
  </body>
</html>
